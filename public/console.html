<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudIdada - Cloud File Management Console</title>
    <meta name="description" content="CloudIdada - Professional cloud file management console with secure storage, API integration, and real-time analytics">
    <meta name="keywords" content="cloud storage, file management, API, CloudIdada, file upload, secure storage">
    <meta name="author" content="CloudIdada">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo.png">
    <meta property="og:title" content="CloudIdada - Cloud File Management Console">
    <meta property="og:description" content="Professional cloud file management with secure storage and API integration">
    <meta property="og:image" content="/logo.png">
    <meta property="og:type" content="website">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
        }

        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #3b82f6;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .logo img {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .logo img:hover {
            transform: scale(1.05);
        }

        .logo p {
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #6b7280;
        }

        .auth-switch a {
            color: #3b82f6;
            text-decoration: none;
            cursor: pointer;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
            display: flex;
            align-items: center;
        }

        .header-logo img {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6b7280;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .page-description {
            color: #6b7280;
            font-size: 16px;
        }

        /* API Keys Grid */
        .api-keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .api-key-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .api-key-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .api-key-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .api-key-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .api-key-purpose {
            color: #6b7280;
            font-size: 14px;
            text-transform: capitalize;
        }

        .api-key-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .copy-btn {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #f0f9ff;
        }

        .api-key-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Generate API Key */
        .generate-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .generate-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .generate-btn:hover {
            background: #059669;
        }
        
        .primary-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff30;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Individual API Key Page */
        .api-key-detail {
            display: none;
        }

        .breadcrumb {
            margin-bottom: 24px;
        }

        .breadcrumb a {
            color: #3b82f6;
            text-decoration: none;
        }

        .breadcrumb span {
            color: #6b7280;
            margin: 0 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .detail-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
        }

        .detail-card h3 {
            color: #111827;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .metric-number {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .metric-name {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media (max-width: 768px) {
            .api-keys-grid {
                grid-template-columns: 1fr;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 16px;
            }
        }

        /* File Preview Styles */
        .file-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .file-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .preview-btn {
            background: #3b82f6;
            color: white;
        }

        .preview-btn:hover {
            background: #2563eb;
        }

        .download-btn {
            background: #10b981;
            color: white;
        }

        .download-btn:hover {
            background: #059669;
        }

        .file-preview {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-preview.active {
            display: block;
        }

        .file-preview pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 4px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .preview-title {
            font-weight: 600;
            color: #374151;
        }

        .close-preview {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .close-preview:hover {
            background: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body>
    <!-- Login/Register Page -->
    <div id="authPage" class="login-page">
        <div class="login-container">
            <div class="logo">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                    <div style="
                        width: 40px; 
                        height: 40px; 
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
                        border-radius: 8px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        margin-right: 8px;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                        border: 2px solid rgba(255, 255, 255, 0.2);
                    ">
                        <span style="
                            color: white; 
                            font-size: 24px; 
                            font-weight: bold; 
                            font-family: 'Arial', sans-serif;
                        ">C</span>
                    </div>
                    <h1 style="margin: 0; font-size: 24px;">CloudIdada</h1>
                </div>
                <p>API Keys Management Console</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <h2 style="margin-bottom: 24px; color: #111827; text-align: center;">Sign In</h2>
                
                <form id="loginFormSubmit">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    
                    <button type="submit" class="btn" id="loginBtn">
                        <span id="loginBtnText">Sign In</span>
                    </button>
                </form>
                
                <div id="loginError" class="error" style="display: none;"></div>
                
                <div class="auth-switch">
                    Don't have an account? <a onclick="showRegister()">Register here</a>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <h2 style="margin-bottom: 24px; color: #111827; text-align: center;">Create Account</h2>
                
                <form id="registerFormSubmit">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="registerName" placeholder="Enter your name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password" required>
                    </div>
                    
                    <button type="submit" class="btn" id="registerBtn">
                        <span id="registerBtnText">Create Account</span>
                    </button>
                </form>
                
                <div id="registerError" class="error" style="display: none;"></div>
                
                <div class="auth-switch">
                    Already have an account? <a onclick="showLogin()">Sign in here</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="dashboard">
        <header class="header">
            <div class="header-content">
                <div class="header-logo">
                    <div style="
                        width: 32px; 
                        height: 32px; 
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
                        border-radius: 6px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        margin-right: 6px;
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                    ">
                        <span style="
                            color: white; 
                            font-size: 18px; 
                            font-weight: bold; 
                            font-family: 'Arial', sans-serif;
                        ">C</span>
                    </div>
                    CloudIdada Console
                </div>
                <div class="user-info">
                    <span id="userNameDisplay">Loading...</span>
                    <button onclick="logout()" style="background: none; border: none; color: #dc2626; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="mainView">
                <div class="page-header">
                    <h1 class="page-title">API Keys Dashboard</h1>
                    <p class="page-description">Manage your API keys with individual analytics - each key has its own dedicated page</p>
                </div>

                <!-- API Keys Grid -->
                <div class="api-keys-grid" id="apiKeysGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading your API keys...
                    </div>
                </div>

                <!-- Generate New API Key -->
                <div class="generate-section">
                    <h3 style="margin-bottom: 16px; color: #111827;">Need more API keys?</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Generate additional API keys for different environments</p>
                    <button class="generate-btn" onclick="generateNewApiKey()">
                        <i class="fas fa-plus"></i>
                        Generate New API Key
                    </button>
                </div>
            </div>

            <!-- Individual API Key Detail View -->
            <div id="apiKeyDetailView" class="api-key-detail">
                <div class="breadcrumb">
                    <a onclick="showMainView()">API Keys</a>
                    <span>/</span>
                    <span id="currentApiKeyName">Loading...</span>
                </div>

                <div class="page-header">
                    <h1 class="page-title" id="detailApiKeyName">API Key Details</h1>
                    <p class="page-description" id="detailApiKeyDescription">Individual analytics and settings</p>
                </div>

                <!-- Metrics Grid -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-number" id="detailRequests">0</div>
                        <div class="metric-name">Total Requests</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-number" id="detailUploads">0</div>
                        <div class="metric-name">File Uploads</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-number" id="detailStorage">0 MB</div>
                        <div class="metric-name">Storage Used</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-number" id="detailLastUsed">Never</div>
                        <div class="metric-name">Last Used</div>
                    </div>
                </div>

                <!-- Detail Cards -->
                <div class="detail-grid">
                    <div class="detail-card">
                        <h3><i class="fas fa-key"></i> API Key Information</h3>
                        <div class="form-group">
                            <label>API Key ID</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="detailApiKeyId" readonly style="flex: 1; background: #f9fafb;">
                                <button class="copy-btn" onclick="copyApiKeyDetail()" title="Copy API Key">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Purpose</label>
                            <input type="text" id="detailPurpose" readonly style="background: #f9fafb;">
                        </div>
                        <div class="form-group">
                            <label>Created</label>
                            <input type="text" id="detailCreated" readonly style="background: #f9fafb;">
                        </div>
                    </div>

                    <div class="detail-card">
                        <h3><i class="fas fa-shield-alt"></i> Permissions</h3>
                        <div id="permissionsList">
                            Loading permissions...
                        </div>
                    </div>
                </div>

                <!-- File Types -->
                <div class="detail-card">
                    <h3><i class="fas fa-file"></i> Uploaded Files</h3>
                    <div id="uploadedFilesList">
                        Loading uploaded files...
                    </div>
                </div>
                
                <!-- File Types Summary -->
                <div class="detail-card">
                    <h3><i class="fas fa-chart-bar"></i> File Types Summary</h3>
                    <div id="fileTypesList">
                        Loading file types...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('cloudidada_token');
        let currentUser = null;
        let apiKeysData = {};
        let currentApiKeyId = null;

        // Debug token on page load
        console.log('Initial token from localStorage:', authToken);

        // Initialize
        if (authToken && authToken !== 'null' && authToken !== 'undefined') {
            console.log('Valid token found, showing dashboard');
            showDashboard();
        } else {
            console.log('No valid token, showing auth page');
            showAuthPage();
        }

        function showAuthPage() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadApiKeys();
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showMainView() {
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('apiKeyDetailView').style.display = 'none';
            currentApiKeyId = null;
        }

        function showApiKeyDetail(apiKeyId) {
            // Check if the API key exists in our current data
            if (!apiKeysData[apiKeyId]) {
                showError('API key not found in current data. Refreshing...');
                loadApiKeys();
                return;
            }
            
            currentApiKeyId = apiKeyId;
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('apiKeyDetailView').style.display = 'block';
            loadApiKeyDetails(apiKeyId);
        }

        // Auth Handlers
        document.getElementById('loginFormSubmit').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const error = document.getElementById('loginError');
            
            btn.disabled = true;
            document.getElementById('loginBtnText').innerHTML = '<div class="spinner"></div>Signing in...';
            error.style.display = 'none';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.data.token;
                    currentUser = data.data;
                    console.log('Login successful - Token:', authToken);
                    console.log('User data:', currentUser);
                    localStorage.setItem('cloudidada_token', authToken);
                    showDashboard();
                } else {
                    showError(data.message || 'Login failed', error);
                }
            } catch (err) {
                showError('Connection failed. Please try again.', error);
            } finally {
                btn.disabled = false;
                document.getElementById('loginBtnText').textContent = 'Sign In';
            }
        });

        document.getElementById('registerFormSubmit').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const btn = document.getElementById('registerBtn');
            const error = document.getElementById('registerError');
            
            btn.disabled = true;
            document.getElementById('registerBtnText').innerHTML = '<div class="spinner"></div>Creating account...';
            error.style.display = 'none';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userName: name, email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.data.token;
                    currentUser = data.data;
                    console.log('Registration successful - Token:', authToken);
                    console.log('User data:', currentUser);
                    localStorage.setItem('cloudidada_token', authToken);
                    showDashboard();
                } else {
                    showError(data.message || 'Registration failed', error);
                }
            } catch (err) {
                showError('Connection failed. Please try again.', error);
            } finally {
                btn.disabled = false;
                document.getElementById('registerBtnText').textContent = 'Create Account';
            }
        });

        async function loadApiKeys() {
            console.log('loadApiKeys called with token:', authToken);
            try {
                const response = await fetch('/api/user/api-keys', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                console.log('API response status:', response.status);

                if (response.status === 401) {
                    console.log('401 Unauthorized - logging out');
                    logout();
                    return;
                }

                const data = await response.json();
                console.log('API response data:', data);

                if (data.success) {
                    apiKeysData = data.data.apiKeys;
                    console.log('Loaded API keys:', Object.keys(apiKeysData)); // Debug log
                    currentUser = data.data.user;
                    displayApiKeys();
                    updateUserInfo();
                } else {
                    showError('Failed to load API keys');
                }
            } catch (error) {
                console.error('Error in loadApiKeys:', error);
                showError('Connection failed');
            }
        }

        function displayApiKeys() {
            const container = document.getElementById('apiKeysGrid');
            
            if (Object.keys(apiKeysData).length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-key" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <h3 style="margin-bottom: 8px; color: #374151;">No API keys found</h3>
                        <p>Register to automatically get 5-8 API keys</p>
                    </div>
                `;
                return;
            }

            const cards = Object.entries(apiKeysData).map(([keyId, keyData]) => {
                const usage = keyData.usage || {};
                return `
                    <div class="api-key-card" onclick="showApiKeyDetail('${keyId}')">
                        <div class="api-key-header">
                            <div>
                                <div class="api-key-name">${keyData.name || 'API Key'}</div>
                                <div class="api-key-purpose">${keyData.purpose || 'general'} environment</div>
                            </div>
                            <button class="copy-btn" onclick="copyApiKey('${keyId}', event)" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            ${keyId.startsWith('cld_primary_') ? 
                                '<span class="primary-badge" title="Primary API Key - Cannot be deleted"><i class="fas fa-star"></i> Primary</span>' :
                                `<button class="delete-btn" onclick="deleteApiKey('${keyId}', event)" title="Delete API Key" style="margin-left: 8px;">
                                    <i class="fas fa-trash"></i>
                                </button>`
                            }
                        </div>
                        
                        <div class="api-key-id">${keyId}</div>
                        
                        <div class="api-key-stats">
                            <div class="stat-item">
                                <div class="stat-value">${usage.requests || 0}</div>
                                <div class="stat-label">Requests</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${usage.uploads || 0}</div>
                                <div class="stat-label">Uploads</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatBytes(usage.storage || 0)}</div>
                                <div class="stat-label">Storage</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${usage.lastUsed ? 'Recently' : 'Never'}</div>
                                <div class="stat-label">Used</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = cards.join('');
        }

        async function loadApiKeyDetails(apiKeyId) {
            document.getElementById('currentApiKeyName').textContent = apiKeysData[apiKeyId]?.name || 'API Key';
            document.getElementById('detailApiKeyName').textContent = apiKeysData[apiKeyId]?.name || 'API Key';
            document.getElementById('detailApiKeyId').value = apiKeyId;
            document.getElementById('detailPurpose').value = apiKeysData[apiKeyId]?.purpose || 'general';
            document.getElementById('detailCreated').value = new Date(apiKeysData[apiKeyId]?.createdAt || Date.now()).toLocaleDateString();

            const usage = apiKeysData[apiKeyId]?.usage || {};
            document.getElementById('detailRequests').textContent = usage.requests || 0;
            document.getElementById('detailUploads').textContent = usage.uploads || 0;
            document.getElementById('detailStorage').textContent = formatBytes(usage.storage || 0);
            document.getElementById('detailLastUsed').textContent = usage.lastUsed ? new Date(usage.lastUsed).toLocaleDateString() : 'Never';

            // Load detailed analytics
            try {
                const response = await fetch(`/api/user/api-keys/${apiKeyId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.status === 404) {
                    // API key not found, show error and reload the keys
                    showError('API key not found. Refreshing the list...');
                    setTimeout(() => {
                        showMainView();
                        loadApiKeys();
                    }, 2000);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayPermissions(data.data.permissions);
                    displayFileTypes(data.data.analytics.fileTypes);
                    loadUploadedFiles(apiKeyId);
                } else {
                    showError('Failed to load API key details: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load API key details:', error);
                showError('Connection failed while loading API key details');
            }
        }

        function displayPermissions(permissions) {
            const container = document.getElementById('permissionsList');
            const perms = Object.entries(permissions || {}).map(([perm, allowed]) => `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="fas ${allowed ? 'fa-check' : 'fa-times'}" style="color: ${allowed ? '#10b981' : '#ef4444'};"></i>
                    <span style="text-transform: capitalize;">${perm}</span>
                </div>
            `);
            
            container.innerHTML = perms.length ? perms.join('') : '<p style="color: #6b7280;">No permissions configured</p>';
        }

        function displayFileTypes(fileTypes) {
            const container = document.getElementById('fileTypesList');
            const types = Object.entries(fileTypes || {}).map(([type, count]) => `
                <div style="display: inline-block; background: #f3f4f6; padding: 8px 12px; margin: 4px; border-radius: 6px; font-size: 14px;">
                    <strong>${count}</strong> ${type.split('/')[1] || type}
                </div>
            `);
            
            container.innerHTML = types.length ? types.join('') : '<p style="color: #6b7280;">No files uploaded yet</p>';
        }

        async function loadUploadedFiles(apiKeyId) {
            const container = document.getElementById('uploadedFilesList');
            console.log('Loading uploaded files for API key:', apiKeyId);
            
            try {
                const response = await fetch('/api/files/list', {
                    headers: { 'x-api-key': apiKeyId }
                });
                
                const data = await response.json();
                console.log('Files API response:', data);
                
                if (data.success && data.data.files.length > 0) {
                    console.log('Creating file items for', data.data.files.length, 'files');
                    const fileItems = data.data.files.map(file => createFileItem(file, apiKeyId));
                    container.innerHTML = fileItems.join('');
                    console.log('File items created and added to container');
                } else {
                    container.innerHTML = '<p style="color: #6b7280;">No files uploaded with this API key yet</p>';
                }
            } catch (error) {
                console.error('Failed to load files:', error);
                container.innerHTML = '<p style="color: #ef4444;">Failed to load files</p>';
            }
        }

        function createFileItem(file, apiKeyId) {
            const isImage = file.mimetype && file.mimetype.startsWith('image/');
            const isText = file.mimetype && (
                file.mimetype.startsWith('text/') ||
                file.mimetype === 'application/json' ||
                file.mimetype === 'application/javascript'
            );
            
            const fileSize = formatBytes(file.size || 0);
            const uploadDate = new Date(file.uploadedAt).toLocaleString();
            
            return `
                <div class="file-item" id="file-${file.id}">
                    <div class="file-header">
                        <div class="file-info">
                            <div class="file-name">
                                <i class="fas ${getFileIcon(file.mimetype)}"></i>
                                ${file.originalName || file.name}
                            </div>
                            <div class="file-meta">
                                ${fileSize} • ${file.mimetype || 'Unknown type'} • ${uploadDate}
                            </div>
                        </div>
                        <div class="file-actions">
                            ${(isText || isImage) ? `
                                <button class="file-btn preview-btn" onclick="previewFile('${file.id}', '${apiKeyId}', '${isImage ? 'image' : 'text'}')">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            ` : ''}
                            <button class="file-btn download-btn" onclick="downloadFile('${file.id}', '${apiKeyId}', '${file.originalName || file.name}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div class="file-preview" id="preview-${file.id}">
                        <!-- Preview content will be loaded here -->
                    </div>
                </div>
            `;
        }

        function getFileIcon(mimetype) {
            if (!mimetype) return 'fa-file';
            if (mimetype.startsWith('image/')) return 'fa-file-image';
            if (mimetype.startsWith('text/')) return 'fa-file-alt';
            if (mimetype.startsWith('video/')) return 'fa-file-video';
            if (mimetype.startsWith('audio/')) return 'fa-file-audio';
            if (mimetype === 'application/pdf') return 'fa-file-pdf';
            if (mimetype === 'application/json') return 'fa-file-code';
            return 'fa-file';
        }

        async function previewFile(fileId, apiKeyId, type) {
            console.log('Preview file called:', fileId, apiKeyId, type);
            const previewContainer = document.getElementById(`preview-${fileId}`);
            const isActive = previewContainer.classList.contains('active');
            
            if (isActive) {
                previewContainer.classList.remove('active');
                return;
            }
            
            previewContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading preview...</div>';
            previewContainer.classList.add('active');
            console.log('Preview container activated');
            
            try {
                const response = await fetch(`/api/files/${fileId}/content?preview=true`, {
                    headers: { 'x-api-key': apiKeyId }
                });
                
                const data = await response.json();
                console.log('Content API response:', data);
                
                if (data.success) {
                    let previewContent = '';
                    
                    if (type === 'image') {
                        console.log('Creating image preview for:', data.data.url);
                        previewContent = `
                            <div class="preview-header">
                                <span class="preview-title">Image Preview: ${data.data.name}</span>
                                <button class="close-preview" onclick="closePreview('${fileId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div style="text-align: center;">
                                <img src="${data.data.url}" alt="${data.data.name}" style="max-width: 100%; max-height: 300px; border: 1px solid #e5e7eb; border-radius: 8px;" onerror="console.error('Image load failed:', this.src); this.outerHTML='<div style=\\'padding: 20px; color: #ef4444; text-align: center;\\'>Image could not be loaded</div>'">
                                <div style="margin-top: 8px; color: #6b7280; font-size: 12px;">
                                    ${data.data.dimensions ? `${data.data.dimensions.width} × ${data.data.dimensions.height} pixels • ` : ''}${formatBytes(data.data.size)}
                                </div>
                            </div>
                        `;
                    } else {
                        previewContent = `
                            <div class="preview-header">
                                <span class="preview-title">
                                    Text Content: ${data.data.name} 
                                    ${data.data.isPreview ? '(Preview - First 1000 chars)' : '(Complete)'}
                                </span>
                                <button class="close-preview" onclick="closePreview('${fileId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <pre>${escapeHtml(data.data.content)}</pre>
                            ${data.data.isPreview ? '<div style="margin-top: 8px; color: #6b7280; font-size: 12px; font-style: italic;">... content truncated. Download to see full file.</div>' : ''}
                        `;
                    }
                    
                    previewContainer.innerHTML = previewContent;
                } else {
                    previewContainer.innerHTML = `
                        <div class="preview-header">
                            <span class="preview-title" style="color: #ef4444;">Preview Failed</span>
                            <button class="close-preview" onclick="closePreview('${fileId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p style="color: #ef4444;">Failed to load preview: ${data.message || 'Unknown error'}</p>
                    `;
                }
            } catch (error) {
                previewContainer.innerHTML = `
                    <div class="preview-header">
                        <span class="preview-title" style="color: #ef4444;">Preview Error</span>
                        <button class="close-preview" onclick="closePreview('${fileId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p style="color: #ef4444;">Connection error: ${error.message}</p>
                `;
            }
        }

        function closePreview(fileId) {
            const previewContainer = document.getElementById(`preview-${fileId}`);
            previewContainer.classList.remove('active');
        }

        function downloadFile(fileId, apiKeyId, fileName) {
            // Create a temporary link to trigger download
            const downloadUrl = `/api/files/${fileId}/content`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = fileName;
            link.style.display = 'none';
            
            // Set headers for the request (note: this won't work with direct link)
            // Instead, we'll fetch and create blob URL
            fetch(downloadUrl, {
                headers: { 'x-api-key': apiKeyId }
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Download failed:', error);
                showError('Download failed: ' + error.message);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateUserInfo() {
            document.getElementById('userNameDisplay').textContent = currentUser?.name || 'User';
        }

        function copyApiKey(keyId, event) {
            event.stopPropagation();
            navigator.clipboard.writeText(keyId).then(() => {
                const btn = event.target.closest('.copy-btn');
                const icon = btn.querySelector('i');
                const originalClass = icon.className;
                
                icon.className = 'fas fa-check';
                btn.style.color = '#10b981';
                
                setTimeout(() => {
                    icon.className = originalClass;
                    btn.style.color = '';
                }, 2000);
            });
        }

        function copyApiKeyDetail() {
            const keyId = document.getElementById('detailApiKeyId').value;
            navigator.clipboard.writeText(keyId).then(() => {
                const btn = event.target.closest('.copy-btn');
                const icon = btn.querySelector('i');
                const originalClass = icon.className;
                
                icon.className = 'fas fa-check';
                btn.style.color = '#10b981';
                
                setTimeout(() => {
                    icon.className = originalClass;
                    btn.style.color = '';
                }, 2000);
            });
        }

        function generateNewApiKey() {
            if (!authToken) {
                showError('Please login first');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;">
                    <h3 style="margin-bottom: 20px; color: #111827;">Generate New API Key</h3>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 500;">API Key Name</label>
                        <input type="text" id="apiKeyName" placeholder="e.g., Production API" 
                               style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 500;">Purpose</label>
                        <select id="apiKeyPurpose" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                            <option value="production">Production</option>
                            <option value="development">Development</option>
                            <option value="testing">Testing</option>
                            <option value="mobile">Mobile App</option>
                            <option value="web">Web App</option>
                            <option value="backend">Backend Service</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 500;">Description (Optional)</label>
                        <textarea id="apiKeyDescription" placeholder="Describe what this API key will be used for..." 
                                  style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal').remove()" 
                                style="padding: 12px 24px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="createNewApiKey()" id="createBtn"
                                style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Generate API Key
                        </button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
        }

        async function createNewApiKey() {
            const name = document.getElementById('apiKeyName').value.trim();
            const purpose = document.getElementById('apiKeyPurpose').value;
            const description = document.getElementById('apiKeyDescription').value.trim();
            const btn = document.getElementById('createBtn');
            
            if (!name) {
                showError('Please enter an API key name');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>Generating...';
            
            try {
                const response = await fetch('/api/user/api-keys/generate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        purpose: purpose,
                        description: description || `API key for ${purpose} usage`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.querySelector('.modal').remove();
                    
                    // Show success message with the new API key
                    const successModal = document.createElement('div');
                    successModal.id = 'apiKeySuccessModal';
                    successModal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                        justify-content: center; z-index: 1000;
                    `;
                    
                    successModal.innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px;">
                            <h3 style="margin-bottom: 20px; color: #10b981;"><i class="fas fa-check-circle"></i> API Key Generated Successfully!</h3>
                            
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <p style="margin-bottom: 12px; color: #374151; font-weight: 500;">Your new API key:</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <code style="flex: 1; background: white; padding: 12px; border-radius: 4px; font-family: 'Courier New', monospace; word-break: break-all;">${data.data.apiKey.id}</code>
                                    <button onclick="copyToClipboard('${data.data.apiKey.id}', event)" 
                                            style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                            
                            <div style="background: #fef3cd; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <p style="color: #92400e; font-size: 14px; margin: 0;">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    <strong>Important:</strong> Copy this API key now. You won't be able to see it again!
                                </p>
                            </div>
                            
                            <div style="text-align: center;">
                                <button id="gotItBtn"
                                        style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    Got it!
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(successModal);
                    
                    // Add event listener for the "Got it!" button
                    const gotItBtn = document.getElementById('gotItBtn');
                    if (gotItBtn) {
                        gotItBtn.addEventListener('click', function() {
                            console.log('Got it button clicked!');
                            closeSuccessModal();
                        });
                    }
                    
                } else {
                    showError(data.message || 'Failed to generate API key');
                }
                
            } catch (error) {
                showError('Connection failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate API Key';
            }
        }

        function copyToClipboard(text, event) {
            navigator.clipboard.writeText(text).then(() => {
                if (event && event.target) {
                    // Show temporary success message
                    const btn = event.target.closest('button');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    btn.style.background = '#10b981';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#3b82f6';
                    }, 2000);
                } else {
                    // Fallback notification if no event
                    showSuccess('API key copied to clipboard!');
                }
            }).catch(() => {
                showError('Failed to copy to clipboard');
            });
        }

        function closeSuccessModal() {
            // Find and remove the success modal by ID
            const modal = document.getElementById('apiKeySuccessModal');
            if (modal) {
                modal.remove();
            }
            
            // Refresh the API keys list to show the new API key
            console.log('Closing success modal and refreshing API keys...');
            loadApiKeys();
        }

        async function deleteApiKey(keyId, event) {
            if (!authToken) {
                showError('Please login first');
                return;
            }
            
            // Prevent deletion of primary key
            if (keyId.startsWith('cld_primary_')) {
                showError('Cannot delete primary API key');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete this API key?\n\n${keyId}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            const btn = event.target.closest('.delete-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>Deleting...';
            
            try {
                const response = await fetch(`/api/user/api-keys/${keyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('API key deleted successfully');
                    loadApiKeys(); // Reload the keys
                } else {
                    showError(data.message || 'Failed to delete API key');
                }
                
            } catch (error) {
                showError('Connection failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash"></i>';
            }
        }

        function logout() {
            console.log('Logging out - clearing token');
            localStorage.removeItem('cloudidada_token');
            localStorage.clear(); // Clear all localStorage data
            authToken = null;
            currentUser = null;
            showAuthPage();
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showError(message, container) {
            if (container) {
                container.textContent = message;
                container.style.display = 'block';
                setTimeout(() => {
                    container.style.display = 'none';
                }, 5000);
            } else {
                alert(message);
            }
        }

        function showSuccess(message) {
            // Create a temporary success message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #10b981; color: white;
                padding: 12px 20px; border-radius: 8px; z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3004);
        }

    </script>
</body>
</html>
 